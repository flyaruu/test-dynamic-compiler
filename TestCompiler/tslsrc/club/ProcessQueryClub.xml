<?xml version="1.0" encoding="UTF-8"?>
<tsl>
    <!-- Includes -->
    <include script="sportlinkservices/include/IncludeUnionParameters" />
    <!-- Show club details by calling webservice -->
    <map object="com.dexels.navajo.adapter.NavajoMap">
        <field name="server">
            <expression value="[/@NavajoServer]" />
        </field>
        <field name="username">
            <expression value="[/@Username]"/>
        </field>
        <field name="password">
            <expression value="[/@Password]"/>
        </field>
        <field name="sendThrough">
            <expression value="true"/>
        </field>
        <field name="doSend">
            <expression value="'club/ProcessQueryClub'"/>
        </field>
        <field name="append"> 
            <expression value="'/'"/>
        </field>
        <param name="ZipCode">
            <expression condition="$property('ClubData/ZipCode') != null AND $property('ClubData/ZipCode') != ''" value="ToUpper( Trim( StringFunction( 'replaceAll', $property('ClubData/ZipCode'), ' ', '' ) ) )"/>
            <expression condition="" value="null"/>
        </param>    
        <param name="ClubId">
            <expression value="$property('ClubData/ClubIdentifier')"/>
        </param>    
    </map>
    <message name="ClubData">
        <property name="DefaultSport" direction="out" description="Bondssport" type="string">
            <expression value="[/@DefaultSport]"/>
        </property>
        <!--  get latitude and longitude -->
        <map object="com.dexels.navajo.adapter.SQLMap">
            <field name="datasource">
                <expression value="'sportlinkkernel'" />
            </field>
            <param name="TransactionContext">
                <expression value="$transactionContext"/>
            </param>
            <param name="ZipCodeExists">
                <expression value="SingleValueQuery([/@TransactionContext], 'SELECT COUNT(*) FROM zipcodeposition WHERE zipcode = ? AND latitude IS NOT NULL', [@ZipCode]) != 0" />
            </param>
            <param name="Latitude">                
                <expression value="-1" />
            </param>
            <param name="Longitude">
                <expression value="-1" />
            </param>
            <!-- if !ZipCodeExists get it from Tensing -->
            <map object="com.dexels.sportlink.adapters.Tensing" condition="![@ZipCodeExists] AND [@ZipCode] != null">
                <field name="zipCodeFrom">
                    <expression value="[@ZipCode]" />
                </field>
                <field name="zipCodeTo">
                    <expression value="[@ZipCode]" />
                </field>
                <field name="calculate">
                    <expression value="true" />
                </field>
                <param name="NewLatitude" direction="out">
                    <expression value="$latitudeTo" />
                </param>
                <param name="NewLongitude" direction="out">
                    <expression value="$longitudeTo" />
                </param>
                <param name="NewStreetName" direction="out">
                    <expression value="$streetName" />
                </param>
                <map condition="ToDouble( [@NewLatitude] ) != -1.0 AND ToDouble( [@NewLongitude] ) != -1.0" object="com.dexels.navajo.adapter.SQLMap">
                    <field name="transactionContext">
                        <expression value="[/@TransactionContext]" />
                    </field>
                    <field name="update">
                        <expression xml:space="preserve">
                            INSERT INTO zipcodeposition (zipcode, latitude, longitude, streetname, updateby, lastupdate) 
                            VALUES ( ?, ?, ?, ?, ?, ? )
                        </expression>
                    </field>
                    <field name="parameter">
                        <expression value="[@ZipCode]" />
                    </field>
                    <field name="parameter">
                        <expression value="ToDouble([@NewLatitude])" />
                    </field>
                    <field name="parameter">
                        <expression value="ToDouble([@NewLongitude])" />
                    </field>
                    <field name="parameter">
                        <expression value="[@NewStreetName]" />
                    </field>
                    <field name="parameter">
                        <expression value="'ADMIN'" />
                    </field>
                    <field name="parameter">
                        <expression value="TODAY" />
                    </field>
                    <field name="doUpdate">
                        <expression value="true" />
                    </field>
                </map>
            </map>                 
        </map>                    
        <!--  get latitude and longitude -->
        <map object="com.dexels.navajo.adapter.SQLMap">
            <field name="datasource">
                <expression value="'sportlinkkernel'" />
            </field>
            <field name="query">
                <expression xml:space="preserve">
                    SELECT latitude, longitude 
                    FROM   zipcodeposition 
                    WHERE  zipcode = ? 
                </expression>
            </field>
            <field name="parameter">
                <expression value="[/@ZipCode]" />
            </field>
            <param name="Latitude">
                <expression condition="$rowCount == 1" value="$columnValue('latitude')" />
                <expression value="-1" />
            </param>
            <param name="Longitude">
                <expression condition="$rowCount == 1" value="$columnValue('longitude')" />
                <expression value="-1" />
            </param>            
        </map>    
        <!-- Last resort -->
        <message mode="ignore" condition="[/@Latitude] &lt; 0" name="CommunityLocation">
            <map object="com.dexels.navajo.adapter.SQLMap">
                <field name="datasource">
                    <expression value="'sportlinkkernel'" />
                </field>
                <field name="query">
                    <expression xml:space="preserve">
                        SELECT latitude
                        ,      longitude
                        FROM   community
                        WHERE  community.communityid = ( SELECT MAX(communityid)
                                                         FROM   postcodetable
                                                         WHERE  postcode = ?
                                                        )
                    </expression>
                </field>
                <field name="parameter">
                    <expression value="[/@ZipCode]" />
                </field>
                <param name="Latitude">
                    <expression condition="$rowCount == 1" value="$columnValue('latitude')" />
                    <expression value="-1" />
                </param>
                <param name="Longitude">
                    <expression condition="$rowCount == 1" value="$columnValue('longitude')" />
                    <expression value="-1" />
                </param>            
            </map>  
        </message>
        <property name="Latitude" type="string" direction="out">
            <expression value="[/@Latitude]" />
        </property>
        <property name="Longitude" type="string" direction="out">
            <expression value="[/@Longitude]" />
        </property>                
    </message>        
</tsl>
